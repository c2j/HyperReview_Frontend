
import React, { createContext, useState, useContext, ReactNode, useEffect } from 'react';

type Language = 'zh' | 'en';

const translations = {
  zh: {
    'app.title': 'HyperReview v3.1',
    'titlebar.search': '全局搜索 (Ctrl+F)',
    'titlebar.mode': '代码审核模式',
    'titlebar.semantic': '语义上下文',
    'titlebar.syncing': '同步中',
    'titlebar.sync_online': '系统在线',
    'titlebar.settings': '设置',
    'titlebar.help': '新手引导',
    'toolbar.open_repo': '打开仓库',
    'toolbar.new_task': '新建任务',
    'toolbar.import_task': '导入任务',
    'toolbar.submit_to': '提交至',
    'toolbar.quick_tags': '快捷标签',
    'toolbar.manage': '管理...',
    'toolbar.current_repo': '当前仓库',
    'toolbar.files_pending': '待审文件',
    'toolbar.gerrit_import': '从 Gerrit 导入 Change',
    'toolbar.server_config': '服务器配置',
    'toolbar.connected_status': '已连接: #{{id}} ({{ps}})',
    'tasktree.review_pending': '待评审 PR',
    'tasktree.watching': '关注中',
    'tasktree.tab.local': '本地任务',
    'tasktree.gerrit_changes': 'GERRIT 变更',
    'tasktree.reviewed_status': '{{reviewed}}/{{total}} 已阅',
    'tasktree.workspace_explorer': '工作空间资源管理器',
    'tasktree.ps_updated_tip': '自上次评审后补丁集已更新',
    'tasktree.fetching': '正在获取 Gerrit 数据...',
    'diffview.file': '文件',
    'diffview.fold_imports': '折叠 Import',
    'diffview.fold_lombok': '折叠 Lombok',
    'diffview.loading': '正在加载差异...',
    'diffview.search.placeholder': '在差异中搜索...',
    'diffview.search.no_results': '未找到',
    'diffview.header.old': '旧版本',
    'diffview.header.new': '新版本',
    'diffview.header.main': '代码变更',
    'diffview.view.diff': '差异视图',
    'diffview.view.old': '仅显示旧版',
    'diffview.view.new': '仅显示新版',
    'contextmenu.must_change': '必须修改',
    'contextmenu.concern': '标记疑虑',
    'contextmenu.approve_hunk': '通过此块',
    'rightpanel.tab.heatmap': '热力图',
    'rightpanel.tab.blame': '责任链',
    'rightpanel.tab.kb': '知识库',
    'rightpanel.tab.gerrit': '远程面板',
    'rightpanel.risk_map': '变更风险地图',
    'rightpanel.line_provenance': '代码行溯源',
    'rightpanel.knowledge_base': '团队评审知识库',
    'rightpanel.kb_desc': '基于项目历史与最佳实践自动匹配。',
    'rightpanel.aggregating': '正在聚合上下文...',
    'rightpanel.gerrit.progress': '评审进度',
    'rightpanel.gerrit.votes': '标签与投票',
    'rightpanel.gerrit.checklist': '智能检查清单',
    'rightpanel.history.task': '任务',
    'modal.open_repo.step1': '选择本地 Git 仓库',
    'modal.open_repo.search': '搜索或输入路径...',
    'modal.open_repo.recent': '最近访问',
    'modal.open_repo.open_local': '浏览本地目录',
    'modal.open_repo.cancel': '取消',
    'modal.open_repo.next': '下一步',
    'modal.open_repo.empty_desc': '未找到匹配的仓库',
    'modal.submit.title': '提交本地评审',
    'modal.submit.ready': '评审已就绪',
    'modal.submit.target': '目标',
    'modal.submit.gerrit_title': '发布 Gerrit 评审',
    'modal.submit.gerrit_desc': '批量发布 {{count}} 条草稿评论',
    'modal.submit.decision': '决策 (投票)',
    'modal.submit.just_drafts': '仅发布草稿',
    'modal.submit.publish_plus_2': '发布并打分 +2',
    'modal.submit.publish_minus_2': '发布并打分 -2',
    'modal.submit.quick_phrases': '快捷短语',
    'modal.submit.stats_title': '待发布统计',
    'modal.submit.blockers': '阻塞点',
    'modal.submit.drafts_count': '条草稿',
    'modal.submit.questions': '个问题',
    'modal.submit.summary_placeholder': '添加最终总结说明...',
    'modal.submit.gates': '质量门禁状态',
    'modal.submit.submitting': '正在提交...',
    'modal.submit.approve_merge': '批准并合并',
    'modal.submit.cancel': '返回',
    'modal.new_task.title': '新建评审任务',
    'modal.new_task.tab_import': '导入远程',
    'modal.new_task.tab_create': '手动创建',
    'modal.import_task.label': '任务 ID 或链接',
    'modal.import_task.or': '或',
    'modal.import_task.drag': '拖入补丁文件 (.diff / .patch)',
    'modal.import_task.supports': '支持从 GitLab/GitHub 的 URL 直接导入',
    'modal.import_task.cancel': '取消',
    'modal.import_task.import': '开始导入',
    'modal.create_task.label_title': '任务标题',
    'modal.create_task.label_type': '任务类型',
    'modal.create_task.type_code': '代码逻辑',
    'modal.create_task.type_sql': 'SQL审计',
    'modal.create_task.type_security': '安全专项',
    'modal.create_task.cancel': '取消',
    'modal.create_task.create': '创建任务',
    'modal.tag_manager.title': '标签管理器',
    'modal.tag_manager.loading': '正在加载标签...',
    'modal.tag_manager.no_tags': '暂无自定义标签',
    'modal.tag_manager.add': '新增标签',
    'modal.tag_manager.placeholder': '标签名称...',
    'modal.tag_manager.done': '完成',
    'modal.sync.title': '远程同步状态',
    'modal.sync.syncing': '正在同步...',
    'modal.sync.uptodate': '已是最新',
    'modal.sync.pulling': '正在从远程拉取最新提交...',
    'modal.sync.last_sync': '同步成功',
    'modal.sync.close': '关闭',
    'modal.branch_compare.title': '分支比较配置',
    'modal.branch_compare.step2': '配置对比分支',
    'modal.branch_compare.base': '基准分支 (Base)',
    'modal.branch_compare.compare': '目标分支 (Compare)',
    'modal.branch_compare.swap': '交换方向',
    'modal.branch_compare.back': '上一步',
    'modal.branch_compare.start': '开始评审',
    'modal.branch_compare.apply': '应用变更',
    'modal.branch_compare.loading': '加载分支中...',
    'modal.settings.title': '系统设置',
    'modal.settings.general': '常规设置',
    'modal.settings.editor': '编辑器配置',
    'modal.settings.shortcuts': '快捷键方案',
    'modal.settings.ai': 'AI 增强助手',
    'modal.settings.appearance': '外观自定义',
    'modal.settings.language': '显示语言',
    'modal.settings.font_size': '代码字号',
    'modal.settings.font_size_desc': '调整代码差异视图的基准字号',
    'modal.settings.ligatures': '启用连字 (Ligatures)',
    'modal.settings.ligatures_desc': '改善 ->, != 等符号的合并显示',
    'modal.settings.behavior': '操作行为',
    'modal.settings.vim': '启用 Vim 模式',
    'modal.settings.vim_desc': '启用核心命令模式与 HJKL 导航',
    'modal.settings.ai_model': 'AI 模型',
    'modal.settings.ai_token': 'API 令牌 (Key)',
    'modal.settings.ai_base_url': '接口地址 (Base URL)',
    'modal.settings.done': '完成设置',
    'modal.review_action.concern': '标记疑虑',
    'modal.review_action.reject': '打回修改',
    'modal.review_action.question': '发起提问',
    'modal.review_action.comment': '添加备注',
    'modal.review_action.markdown': '支持 Markdown 语法',
    'modal.review_action.cancel': '取消',
    'modal.review_action.post': '发布',
    'command.placeholder': '搜索文件、命令或符号...',
    'command.esc': '退出',
    'command.tips': '按上下键选择，回车确认',
    'statusbar.live': '本地实时',
    'statusbar.ready': '准备就绪 → 推送至 CodeArts',
    'statusbar.ready_remote': '准备向 Gerrit 推送 {{count}} 条注释',
    'statusbar.saved': '已保存',
    'statusbar.loading_stats': '正在加载统计...',
    'statusbar.files': '个文件',
    'statusbar.marked': '已阅',
    'welcome.tag': 'Version 3.1 实时版',
    'welcome.title': 'HyperReview',
    'welcome.subtitle': '专为 Tech Lead 打造的高性能代码评审终端',
    'welcome.local_title': '本地工作区',
    'welcome.local_desc': '评审本地 Git 仓库，分析影响范围图谱，离线管理任务。',
    'welcome.local_btn': '打开本地目录',
    'welcome.remote_title': 'Gerrit 远程',
    'welcome.remote_desc': '直接获取 Gerrit 变更，同步草稿评论，并向服务器投票。',
    'welcome.remote_btn': '从 Gerrit 导入',
    'welcome.history_title': '最近访问',
    'welcome.history_clear': '清除历史',
    'welcome.history_last_opened': '上次打开于 {{time}}',
    'welcome.guide.title': '连接你的工作流',
    'welcome.guide.desc': '检测到尚未配置 Gerrit 服务器。为了实现跨补丁集（PatchSet）评审、草稿同步等 Tech Lead 核心功能，建议您先完成服务器配置。',
    'welcome.guide.btn': '立即配置服务器',
    'welcome.guide.setup_needed': '需要配置',
    'gerrit.server.title': 'Gerrit 服务器配置',
    'gerrit.server.url': 'Gerrit 服务器 URL',
    'gerrit.server.username': '用户名',
    'gerrit.server.auth_type': '认证方式',
    'gerrit.server.token': 'HTTP 凭据 / Token',
    'gerrit.server.token_tip': '提示：在 Gerrit 界面 Settings -> HTTP Password 中获取',
    'gerrit.server.test': '测试连接',
    'gerrit.server.save': '保存并连接',
    'gerrit.server.testing': '正在测试...',
    'gerrit.server.success': '连接成功！Gerrit 版本: {{version}}',
    'gerrit.server.failed': '连接失败，请检查 URL 和 Token',
    'gerrit.server.cancel': '取消',
    'gerrit.import.title': '从 Gerrit 导入',
    'gerrit.import.bridge': 'Gerrit REST API 桥接',
    'gerrit.import.connected_to': '已连接至 {{server}} ({{version}})',
    'gerrit.import.label': '导入 Gerrit Change',
    'gerrit.import.placeholder': 'Change ID 或搜索条件...',
    'gerrit.import.btn': '导入',
    'gerrit.import.fetching': '获取中...',
    'gerrit.import.suggestions': '常用搜索建议',
    'gerrit.import.config_btn': '配置服务器与 Token',
    'actionbar.approve': '通过',
    'actionbar.mark_reviewed': '标记已阅 (R)',
    'actionbar.next_file': '下一个文件',
    'actionbar.batch_publish': '批量发布',
    'actionbar.current_reviewed': '标记当前已阅',
    'actionbar.concern': '关注点',
    'actionbar.reject': '打回',
    'actionbar.comment': '评论',
    'actionbar.go_def': '跳转定义',
    'tour.welcome.title': '欢迎使用 HyperReview',
    'tour.welcome.content': '让我们花 1 分钟了解如何像专家一样进行代码评审。',
    'tour.tasks.title': '任务与文件',
    'tour.tasks.content': '在这里管理你的所有 Gerrit Change 或本地对比分支。',
    'tour.toolbar.title': '快速操作栏',
    'tour.toolbar.content': '切换仓库、新建任务、管理标签，一切触手可及。',
    'tour.diff.title': '高性能差异引擎',
    'tour.diff.content': '享受零延迟的代码对比体验，支持多 PatchSet 切换。',
    'tour.right.title': '深度洞察',
    'tour.right.content': '查看热力图风险、责任链溯源和智能评审指南。',
    'tour.action.title': '评审决策',
    'tour.action.content': '一键打回或批准，所有操作通过键盘快捷键秒级完成。',
    'tour.finish.title': '准备就绪',
    'tour.finish.content': '现在，开始你的高性能评审之旅吧！',
    'tour.prev': '上一步',
    'tour.next': '下一步',
    'tour.finish': '结束引导'
  },
  en: {
    'app.title': 'HyperReview v3.1',
    'titlebar.search': 'Global Search (Ctrl+F)',
    'titlebar.mode': 'Review Mode',
    'titlebar.semantic': 'Semantic Context',
    'titlebar.syncing': 'Syncing',
    'titlebar.sync_online': 'Online',
    'titlebar.settings': 'Settings',
    'titlebar.help': 'Tour Guide',
    'toolbar.open_repo': 'Open Repo',
    'toolbar.new_task': 'New Task',
    'toolbar.import_task': 'Import Task',
    'toolbar.submit_to': 'Submit to',
    'toolbar.quick_tags': 'Quick Tags',
    'toolbar.manage': 'Manage...',
    'toolbar.current_repo': 'Current Repo',
    'toolbar.files_pending': 'Files Pending',
    'toolbar.gerrit_import': 'Import from Gerrit',
    'toolbar.server_config': 'Server Config',
    'toolbar.connected_status': 'CONNECTED: #{{id}} ({{ps}})',
    'tasktree.review_pending': 'Pending PRs',
    'tasktree.watching': 'Watching',
    'tasktree.tab.local': 'Local Tasks',
    'tasktree.gerrit_changes': 'GERRIT CHANGES',
    'tasktree.reviewed_status': '{{reviewed}}/{{total}} reviewed',
    'tasktree.workspace_explorer': 'Workspace Explorer',
    'tasktree.ps_updated_tip': 'PS has been updated since last review',
    'tasktree.fetching': 'Fetching Gerrit data...',
    'diffview.file': 'File',
    'diffview.fold_imports': 'Fold Imports',
    'diffview.fold_lombok': 'Fold Lombok',
    'diffview.loading': 'Loading diff...',
    'diffview.search.placeholder': 'Search in diff...',
    'diffview.search.no_results': 'Not found',
    'diffview.header.old': 'Old Version',
    'diffview.header.new': 'New Version',
    'diffview.header.main': 'Changes',
    'diffview.view.diff': 'Diff View',
    'diffview.view.old': 'Show Old Only',
    'diffview.view.new': 'Show New Only',
    'contextmenu.must_change': 'Must Change',
    'contextmenu.concern': 'Mark Concern',
    'contextmenu.approve_hunk': 'Approve Hunk',
    'rightpanel.tab.heatmap': 'Heatmap',
    'rightpanel.tab.blame': 'Blame',
    'rightpanel.tab.kb': 'Knowledge Base',
    'rightpanel.tab.gerrit': 'Remote Panel',
    'rightpanel.risk_map': 'Change Risk Map',
    'rightpanel.line_provenance': 'Line Provenance',
    'rightpanel.knowledge_base': 'Team Knowledge Base',
    'rightpanel.kb_desc': 'Auto-matched based on history and best practices.',
    'rightpanel.aggregating': 'Aggregating context...',
    'rightpanel.gerrit.progress': 'Review Progress',
    'rightpanel.gerrit.votes': 'Labels & Votes',
    'rightpanel.gerrit.checklist': 'Smart Checklist',
    'rightpanel.history.task': 'Task',
    'modal.open_repo.step1': 'Select Local Git Repo',
    'modal.open_repo.search': 'Search or enter path...',
    'modal.open_repo.recent': 'RECENTLY ACCESSED',
    'modal.open_repo.open_local': 'Browse Local Directory',
    'modal.open_repo.cancel': 'Cancel',
    'modal.open_repo.next': 'Next',
    'modal.open_repo.empty_desc': 'No matching repositories found',
    'modal.submit.title': 'Submit Local Review',
    'modal.submit.ready': 'Review Ready',
    'modal.submit.target': 'Target',
    'modal.submit.gerrit_title': 'Publish Gerrit Review',
    'modal.submit.gerrit_desc': 'Batch publishing {{count}} draft comments',
    'modal.submit.decision': 'Decision (Votes)',
    'modal.submit.just_drafts': 'Just Drafts',
    'modal.submit.publish_plus_2': 'Publish +2',
    'modal.submit.publish_minus_2': 'Publish -2',
    'modal.submit.quick_phrases': 'Quick Phrases',
    'modal.submit.stats_title': 'Pending Stats',
    'modal.submit.blockers': 'Blockers',
    'modal.submit.drafts_count': 'Drafts',
    'modal.submit.questions': 'Question',
    'modal.submit.summary_placeholder': 'Add a final summary message...',
    'modal.submit.gates': 'Quality Gate Status',
    'modal.submit.submitting': 'Submitting...',
    'modal.submit.approve_merge': 'Approve & Merge',
    'modal.submit.cancel': 'Back',
    'modal.new_task.title': 'New Review Task',
    'modal.new_task.tab_import': 'Import Remote',
    'modal.new_task.tab_create': 'Manual Create',
    'modal.import_task.label': 'Task ID or Link',
    'modal.import_task.or': 'OR',
    'modal.import_task.drag': 'Drop patch file (.diff / .patch)',
    'modal.import_task.supports': 'Supports URL from GitLab/GitHub directly',
    'modal.import_task.cancel': 'Cancel',
    'modal.import_task.import': 'Import Now',
    'modal.create_task.label_title': 'Task Title',
    'modal.create_task.label_type': 'Task Type',
    'modal.create_task.type_code': 'Code Logic',
    'modal.create_task.type_sql': 'SQL Audit',
    'modal.create_task.type_security': 'Security special',
    'modal.create_task.cancel': 'Cancel',
    'modal.create_task.create': 'Create Task',
    'modal.tag_manager.title': 'Tag Manager',
    'modal.tag_manager.loading': 'Loading tags...',
    'modal.tag_manager.no_tags': 'No custom tags found',
    'modal.tag_manager.add': 'Add Tag',
    'modal.tag_manager.placeholder': 'Tag label...',
    'modal.tag_manager.done': 'Done',
    'modal.sync.title': 'Sync Status',
    'modal.sync.syncing': 'Syncing...',
    'modal.sync.uptodate': 'Up to date',
    'modal.sync.pulling': 'Pulling latest commits from origin...',
    'modal.sync.last_sync': 'Sync Successful',
    'modal.sync.close': 'Close',
    'modal.branch_compare.title': 'Branch Configuration',
    'modal.branch_compare.step2': 'Setup comparison',
    'modal.branch_compare.base': 'Base Branch',
    'modal.branch_compare.compare': 'Compare Branch',
    'modal.branch_compare.swap': 'Swap Direction',
    'modal.branch_compare.back': 'Back',
    'modal.branch_compare.start': 'Start Review',
    'modal.branch_compare.apply': 'Apply',
    'modal.branch_compare.loading': 'Loading branches...',
    'modal.settings.title': 'Settings',
    'modal.settings.general': 'General',
    'modal.settings.editor': 'Editor',
    'modal.settings.shortcuts': 'Shortcuts',
    'modal.settings.ai': 'AI Assistant',
    'modal.settings.appearance': 'Appearance',
    'modal.settings.language': 'Language',
    'modal.settings.font_size': 'Font Size',
    'modal.settings.font_size_desc': 'Control the font size of the code rendering',
    'modal.settings.ligatures': 'Enable Ligatures',
    'modal.settings.ligatures_desc': 'Improve ->, != etc display',
    'modal.settings.behavior': 'Behavior',
    'modal.settings.vim': 'Vim Mode',
    'modal.settings.vim_desc': 'Tech Lead power mode',
    'modal.settings.ai_model': 'AI Model',
    'modal.settings.ai_token': 'API Token',
    'modal.settings.ai_base_url': 'Base URL',
    'modal.settings.done': 'Save & Apply',
    'modal.review_action.concern': 'Concern',
    'modal.review_action.reject': 'Reject',
    'modal.review_action.question': 'Question',
    'modal.review_action.comment': 'Note',
    'modal.review_action.markdown': 'Markdown supported',
    'modal.review_action.cancel': 'Cancel',
    'modal.review_action.post': 'Post',
    'command.placeholder': 'Search files, commands, symbols...',
    'command.esc': 'ESC',
    'command.tips': 'Use arrow keys to select, enter to confirm',
    'statusbar.live': 'LIVE',
    'statusbar.ready': 'Ready → Push to CodeArts',
    'statusbar.ready_remote': 'Ready to push {{count}} annotations to Gerrit',
    'statusbar.saved': 'Saved',
    'statusbar.loading_stats': 'Loading stats...',
    'statusbar.files': 'files',
    'statusbar.marked': 'marked',
    'welcome.tag': 'Version 3.1 Live',
    'welcome.title': 'HyperReview',
    'welcome.subtitle': 'High-performance terminal for Tech Leads code review',
    'welcome.local_title': 'Local Workspace',
    'welcome.local_desc': 'Review local git repositories, analyze impact maps, and manage tasks offline.',
    'welcome.local_btn': 'Open Local Directory',
    'welcome.remote_title': 'Gerrit Remote',
    'welcome.remote_desc': 'Fetch Gerrit changes directly, sync draft comments, and cast votes to server.',
    'welcome.remote_btn': 'Import from Gerrit',
    'welcome.history_title': 'Recently Accessed',
    'welcome.history_clear': 'Clear History',
    'welcome.history_last_opened': 'Last opened {{time}}',
    'welcome.guide.title': 'Connect Your Workflow',
    'welcome.guide.desc': 'Gerrit server configuration is not detected. To enable cross-PatchSet review, draft syncing, and other Tech Lead core features, please complete the server setup first.',
    'welcome.guide.btn': 'Configure Server Now',
    'welcome.guide.setup_needed': 'Setup Needed',
    'gerrit.server.title': 'Gerrit Server Configuration',
    'gerrit.server.url': 'Gerrit Server URL',
    'gerrit.server.username': 'Username',
    'gerrit.server.auth_type': 'Auth Type',
    'gerrit.server.token': 'HTTP Credentials / Token',
    'gerrit.server.token_tip': 'Tip: Obtain this from Settings -> HTTP Password in Gerrit UI.',
    'gerrit.server.test': 'Test Connection',
    'gerrit.server.save': 'Save & Connect',
    'gerrit.server.testing': 'Testing...',
    'gerrit.server.success': 'Connected! Gerrit Version: {{version}}',
    'gerrit.server.failed': 'Connection failed. Check URL and Token.',
    'gerrit.server.cancel': 'Cancel',
    'gerrit.import.title': 'Import from Gerrit',
    'gerrit.import.bridge': 'Gerrit REST API Bridge',
    'gerrit.import.connected_to': 'Connected to {{server}} ({{version}})',
    'gerrit.import.label': 'Import Gerrit Change',
    'gerrit.import.placeholder': 'Change ID or Search Query...',
    'gerrit.import.btn': 'Import',
    'gerrit.import.fetching': 'Fetching...',
    'gerrit.import.suggestions': 'Common Suggestions',
    'gerrit.import.config_btn': 'Configure Server & Token',
    'actionbar.approve': 'Approve',
    'actionbar.mark_reviewed': 'Mark Reviewed (R)',
    'actionbar.next_file': 'Next File',
    'actionbar.batch_publish': 'Batch Publish',
    'actionbar.current_reviewed': 'Mark Current Reviewed',
    'actionbar.concern': 'Concern',
    'actionbar.reject': 'Reject',
    'actionbar.comment': 'Comment',
    'actionbar.go_def': 'Go to Def',
    'tour.welcome.title': 'Welcome to HyperReview',
    'tour.welcome.content': 'Let\'s take 1 minute to see how to review like a pro.',
    'tour.tasks.title': 'Tasks & Files',
    'tour.tasks.content': 'Manage all your Gerrit changes or local comparison branches here.',
    'tour.toolbar.title': 'Quick Toolbar',
    'tour.toolbar.content': 'Switch repos, create tasks, manage tags, everything at your fingertips.',
    'tour.diff.title': 'High Perf Diff Engine',
    'tour.diff.content': 'Enjoy zero-latency code comparison with multi-PatchSet support.',
    'tour.right.title': 'Deep Insights',
    'tour.right.content': 'View risk maps, line provenance, and smart review guidelines.',
    'tour.action.title': 'Review Decisions',
    'tour.action.content': 'Reject or approve in seconds. All via keyboard shortcuts.',
    'tour.finish.title': 'Ready to Go',
    'tour.finish.content': 'Start your high-performance review journey now!',
    'tour.prev': 'Prev',
    'tour.next': 'Next',
    'tour.finish': 'Finish'
  }
};

const LanguageContext = createContext<{
  language: Language;
  setLanguage: (lang: Language) => void;
  fontSize: number;
  setFontSize: (size: number) => void;
  ligatures: boolean;
  setLigatures: (enabled: boolean) => void;
  vimMode: boolean;
  setVimMode: (enabled: boolean) => void;
  aiModel: string;
  setAiModel: (model: string) => void;
  aiToken: string;
  setAiToken: (token: string) => void;
  aiBaseUrl: string;
  setAiBaseUrl: (url: string) => void;
  t: (key: string, params?: Record<string, string | number>) => string;
}>({
  language: 'zh',
  setLanguage: () => {},
  fontSize: 14,
  setFontSize: () => {},
  ligatures: true,
  setLigatures: () => {},
  vimMode: false,
  setVimMode: () => {},
  aiModel: 'gemini-1.5-pro',
  setAiModel: () => {},
  aiToken: '',
  setAiToken: () => {},
  aiBaseUrl: '',
  setAiBaseUrl: () => {},
  t: (key) => key,
});

export const LanguageProvider: React.FC<{children: ReactNode}> = ({ children }) => {
  // 从 localStorage 初始化状态
  const getInitial = (key: string, def: any) => {
    const saved = localStorage.getItem(`hr_setting_${key}`);
    if (saved === null) return def;
    try { return JSON.parse(saved); } catch { return saved; }
  };

  const [language, _setLanguage] = useState<Language>(getInitial('language', 'zh'));
  const [fontSize, _setFontSize] = useState<number>(getInitial('fontSize', 14));
  const [ligatures, _setLigatures] = useState<boolean>(getInitial('ligatures', true));
  const [vimMode, _setVimMode] = useState<boolean>(getInitial('vimMode', false));
  const [aiModel, _setAiModel] = useState<string>(getInitial('aiModel', 'gemini-1.5-pro'));
  const [aiToken, _setAiToken] = useState<string>(getInitial('aiToken', ''));
  const [aiBaseUrl, _setAiBaseUrl] = useState<string>(getInitial('aiBaseUrl', ''));

  // 持久化包装器
  const setLanguage = (v: Language) => { _setLanguage(v); localStorage.setItem('hr_setting_language', JSON.stringify(v)); };
  const setFontSize = (v: number) => { _setFontSize(v); localStorage.setItem('hr_setting_fontSize', JSON.stringify(v)); };
  const setLigatures = (v: boolean) => { _setLigatures(v); localStorage.setItem('hr_setting_ligatures', JSON.stringify(v)); };
  const setVimMode = (v: boolean) => { _setVimMode(v); localStorage.setItem('hr_setting_vimMode', JSON.stringify(v)); };
  const setAiModel = (v: string) => { _setAiModel(v); localStorage.setItem('hr_setting_aiModel', JSON.stringify(v)); };
  const setAiToken = (v: string) => { _setAiToken(v); localStorage.setItem('hr_setting_aiToken', JSON.stringify(v)); };
  const setAiBaseUrl = (v: string) => { _setAiBaseUrl(v); localStorage.setItem('hr_setting_aiBaseUrl', JSON.stringify(v)); };

  const t = (key: string, params?: Record<string, string | number>): string => {
    let text = (translations[language] as any)[key] || key;
    if (params) {
      Object.entries(params).forEach(([k, v]) => {
        text = text.replace(`{{${k}}}`, String(v));
      });
    }
    return text;
  };

  return (
    <LanguageContext.Provider value={{ 
      language, setLanguage, 
      fontSize, setFontSize, 
      ligatures, setLigatures, 
      vimMode, setVimMode,
      aiModel, setAiModel,
      aiToken, setAiToken,
      aiBaseUrl, setAiBaseUrl,
      t 
    }}>
      {children}
    </LanguageContext.Provider>
  );
};

export const useTranslation = () => useContext(LanguageContext);
